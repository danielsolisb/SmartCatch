{% extends 'base/body.html' %}
{% load static %}
{% block head %}
    
    <!-- jQuery UI -->
    <script src="{% static 'adminlte-3.1.0/plugins/jquery-ui/jquery-ui.min.js' %}"></script>
    <!-- AdminLTE for demo purposes -->    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script src="https://www.gstatic.com/charts/loader.js" type="text/javascript"></script>

    <script src="{% static 'Highcharts-11.1.0/code/highcharts.js'%}"></script>
    <script src="{% static 'Highcharts-11.1.0/code/highcharts-more.js'%}"></script>
    <script src="{% static 'Highcharts-11.1.0/code/modules/exporting.js'%}"></script>
    <script src="{% static 'Highcharts-11.1.0/code/modules/export-data.js'%}"></script>
    <script src="{% static 'Highcharts-11.1.0/code/modules/accessibility.js'%}"></script>
    <script src="{% static 'Highcharts-11.1.0/code/modules/series-label.js'%}"></script>

    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>-->



    <style>
        .highcharts-figure .chart-container {
            width: 300px;
            height: 200px;
            float: left;
        }
        
        .highcharts-figure,
        .highcharts-data-table table {
            width: 400px;
            margin: 0 auto;
        }
        
        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #ebebeb;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 350px;
        }
        
        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }
        
        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }
        
        .highcharts-data-table td,
        .highcharts-data-table th,
        .highcharts-data-table caption {
            padding: 0.5em;
        }
        
        .highcharts-data-table thead tr,
        .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }
        
        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }
        
        @media (max-width: 200px) {
            .highcharts-figure,
            .highcharts-data-table table {
                width: 100%;
            }
        
            .highcharts-figure .chart-container {
                width: 400px;
                float: none;
                margin: 0 auto;
            }
        }
        
    </style>
{% endblock %}

{% block content %}
    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="card card-primary">
              <div class="card-header">
                <h4 class="card-title">{{ subTitle }}</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="row">        
                        <!--graficos-->                    
                        {% for sensor_url, sensorname in sensor_names %}
                        <div class="col-lg-4">
                            <div class="small-box">
                                <figure class="highcharts-figure">
                                    <div id="{{ sensorname }}_container"></div>
                                    </figure>
                            </div>
                        </div>
                        {% endfor %}          
                        <!--/.graficos-->
                        <div class="col-lg-4">
                            <div class="small-box bg-blue" style="text-align:center;"">
                                <svg
                                    width="170"
                                    height="300"
                                    viewBox="0 0 44.979175 79.374959"
                                    version="1.1"
                                    id="svg5"
                                    xml:space="preserve"
                                    inkscape:export-filename="flowCount.svg"
                                    inkscape:export-xdpi="96"
                                    inkscape:export-ydpi="96"
                                    inkscape:version="1.2.2 (732a01da63, 2022-12-09)"
                                    sodipodi:docname="FinalFlowCount2.svg"
                                    xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                                    xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
                                    xmlns="http://www.w3.org/2000/svg"
                                    xmlns:svg="http://www.w3.org/2000/svg"><sodipodi:namedview
                                      id="namedview7"
                                      pagecolor="#ffffff"
                                      bordercolor="#666666"
                                      borderopacity="1.0"
                                      inkscape:showpageshadow="2"
                                      inkscape:pageopacity="0.0"
                                      inkscape:pagecheckerboard="0"
                                      inkscape:deskcolor="#d1d1d1"
                                      inkscape:document-units="mm"
                                      showgrid="false"
                                      inkscape:zoom="1.6699905"
                                      inkscape:cx="37.425363"
                                      inkscape:cy="144.6116"
                                      inkscape:window-width="1350"
                                      inkscape:window-height="704"
                                      inkscape:window-x="0"
                                      inkscape:window-y="0"
                                      inkscape:window-maximized="0"
                                      inkscape:current-layer="layer1" /><defs
                                      id="defs2" /><g
                                      inkscape:label="Capa 1"
                                      inkscape:groupmode="layer"
                                      id="layer1"><g
                                        id="g332"
                                        transform="matrix(0.07513185,0,0,0.07727957,0.58566764,1.1725463)"><path
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          d="M 581,611 V 999 H 483 V 611 Z"
                                          id="path289" /><path
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          d="M 95,709 H 483 V 903 H 95 Z"
                                          id="path291" /><path
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          d="M 95,611 V 999 H 0 V 611 Z"
                                          id="path293" /><path
                                          style="fill:#cccccc"
                                          d="M 581,653 V 957 H 483 V 653 Z"
                                          id="path295" /><path
                                          style="fill:#cccccc"
                                          d="M 95,739 H 483 V 871 H 95 Z"
                                          id="path297" /><path
                                          style="fill:#cccccc"
                                          d="M 95,653 V 957 H 0 V 653 Z"
                                          id="path299" /><path
                                          style="fill:#e5e5e5"
                                          d="M 581,719 V 891 H 483 V 719 Z"
                                          id="path301" /><path
                                          style="fill:#e5e5e5"
                                          d="m 95,775 h 388 v 60 H 95 Z"
                                          id="path303" /><path
                                          style="fill:#e5e5e5"
                                          d="M 95,719 V 891 H 0 V 719 Z"
                                          id="path305" /><path
                                          style="fill:#ffffff"
                                          d="m 581,783 v 44 h -98 v -44 z"
                                          id="path307" /><path
                                          style="fill:#ffffff"
                                          d="m 95,799 h 388 v 12 H 95 Z"
                                          id="path309" /><path
                                          style="fill:#ffffff"
                                          d="m 95,783 v 44 H 0 v -44 z"
                                          id="path311" /><path
                                          style="fill:#e50000;stroke:#4c4c4c;stroke-width:2"
                                          d="M 169,157 95,145 V 11 L 169,0 Z"
                                          id="path313" /><path
                                          style="fill:#e50000;stroke:#4c4c4c;stroke-width:2"
                                          d="m 411,0 72,11 v 134 l -72,12 z"
                                          id="path315" /><path
                                          style="fill:#e5e5e5"
                                          d="m 411,53 h 70 V 35 l -70,-6 z"
                                          id="path317" /><path
                                          style="fill:#e5e5e5"
                                          d="M 169,53 H 99 V 35 l 70,-6 z"
                                          id="path319" /><path
                                          style="fill:#ff0000;stroke:#4c4c4c;stroke-width:2"
                                          d="M 169,0 H 411 V 417 H 169 Z"
                                          id="path321" /><circle
                                          style="fill:#ff0000;stroke:#4c4c4c;stroke-width:2"
                                          cx="290"
                                          cy="193"
                                          r="193"
                                          id="circle323" /><circle
                                          style="fill:#4c4c4c;stroke:#4c4c4c;stroke-width:2"
                                          cx="290"
                                          cy="193"
                                          r="133"
                                          id="circle325" /><path
                                          style="fill:#4c4c4c;stroke:#4c4c4c;stroke-width:2"
                                          d="m 327,715 -1,2 -2,2 -3,2 -4,2 -6,1 -6,2 h -7 l -7,1 -8,-1 h -7 l -6,-2 -6,-1 -4,-2 -4,-2 -2,-2 -1,-2 V 417 h 74 z"
                                          id="path327" /><path
                                          style="fill:#e50000;stroke:#4c4c4c;stroke-width:2"
                                          d="m 315,385 17,-2 15,-4 15,-5 15,-7 14,-7 13,-9 12,-10 11,-11 11,-11 10,-13 9,-13 7,-14 7,-15 5,-15 4,-15 3,-17 h -32 l -2,13 -4,13 -4,12 -6,12 -6,11 -7,11 -8,10 -9,10 -9,9 -10,8 -10,7 -12,6 -11,6 -12,4 -13,4 -13,2 z"
                                          id="path329" /><path
                                          style="fill:#e50000;stroke:#4c4c4c;stroke-width:2"
                                          d="m 483,169 -3,-16 -4,-16 -5,-15 -7,-15 L 457,93 448,80 438,68 427,56 416,45 404,36 391,27 377,19 362,13 347,8 332,4 315,1 l -2,30 13,3 13,3 13,5 12,5 11,7 11,7 10,8 9,9 9,9 8,11 7,10 6,12 6,11 4,13 4,13 2,12 z"
                                          id="path331" /><path
                                          style="fill:#e50000;stroke:#4c4c4c;stroke-width:2"
                                          d="m 265,1 -16,3 -16,4 -15,5 -14,6 -14,8 -13,9 -13,9 -11,11 -11,12 -9,12 -9,13 -8,14 -6,15 -5,15 -5,16 -3,16 h 32 l 3,-12 3,-13 5,-13 5,-11 6,-12 7,-10 8,-11 9,-9 9,-9 10,-8 11,-7 11,-7 12,-5 12,-5 12,-3 13,-3 z"
                                          id="path333" /><path
                                          style="fill:#e50000;stroke:#4c4c4c;stroke-width:2"
                                          d="m 97,217 3,17 4,15 5,15 6,15 8,14 9,13 9,13 11,11 12,11 12,10 13,9 14,7 15,7 15,5 16,4 16,2 v -30 l -13,-2 -12,-4 -12,-4 -12,-6 -11,-6 -11,-7 -10,-8 -9,-9 -9,-10 -8,-10 -7,-11 -6,-11 -5,-12 -5,-12 -3,-13 -3,-13 z"
                                          id="path335" /><path
                                          style="fill:#333333;stroke:#4c4c4c;stroke-width:2"
                                          d="m 201,153 h 176 v 80 H 201 Z"
                                          id="path337" /><path
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          d="m 211,163 h 158 v 60 H 211 Z"
                                          id="Number" /><circle
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          cx="289"
                                          cy="369"
                                          r="10"
                                          id="circle341" /><circle
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          cx="466"
                                          cy="192"
                                          r="9"
                                          id="circle343" /><circle
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          cx="288"
                                          cy="14"
                                          r="9"
                                          id="circle345" /><circle
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          cx="111"
                                          cy="192"
                                          r="10"
                                          id="circle347" /><path
                                          style="fill:#999999;stroke:#4c4c4c;stroke-width:2"
                                          d="M 235,441 H 345 V 563 H 235 Z"
                                          id="path349" /><path
                                          style="fill:#999999;stroke:#4c4c4c;stroke-width:2"
                                          d="m 235,611 h 110 v 36 H 235 Z"
                                          id="path351" /><path
                                          style="fill:#cccccc;stroke:#4c4c4c;stroke-width:2"
                                          d="m 271,441 h 56 v 122 h -56 z"
                                          id="path353" /><path
                                          style="fill:#cccccc;stroke:#4c4c4c;stroke-width:2"
                                          d="m 271,611 h 56 v 36 h -56 z"
                                          id="path355" /><path
                                          style="fill:#666666;stroke:#4c4c4c;stroke-width:2"
                                          d="m 241,441 h 98 v -6 h -98 z"
                                          id="path357" /><path
                                          style="fill:#b2b2b2"
                                          d="m 235,581 h 110 v 18 H 235 Z"
                                          id="path359" /><path
                                          style="fill:#b2b2b2"
                                          d="m 235,659 h 110 v 18 H 235 Z"
                                          id="path361" /><path
                                          style="fill:#cccccc"
                                          d="m 247,581 h 86 v 18 h -86 z"
                                          id="path363" /><path
                                          style="fill:#cccccc"
                                          d="m 247,659 h 86 v 18 h -86 z"
                                          id="path365" /><path
                                          style="fill:#e5e5e5"
                                          d="m 265,581 h 50 v 18 h -50 z"
                                          id="path367" /><path
                                          style="fill:#e5e5e5"
                                          d="m 265,659 h 50 v 18 h -50 z"
                                          id="path369" /><path
                                          style="fill:#ffffff"
                                          d="m 283,659 h 12 v 18 h -12 z"
                                          id="path371" /><path
                                          style="fill:#ffffff"
                                          d="m 283,581 h 12 v 18 h -12 z"
                                          id="path373" /><path
                                          style="fill:#b2b2b2;stroke:#4c4c4c;stroke-width:2"
                                          d="m 193,883 -6,-84 h 206 l -6,84 z"
                                          id="path375" /><path
                                          style="fill:none;stroke:#4c4c4c;stroke-width:2"
                                          d="m 235,659 h 110 v 18 H 235 v -18"
                                          id="path377" /><path
                                          style="fill:none;stroke:#4c4c4c;stroke-width:2"
                                          d="m 235,581 h 110 v 18 H 235 v -18"
                                          id="path379" /></g><text
                                        xml:space="preserve"
                                        style="font-style:normal;font-weight:normal;font-size:3.12326px;line-height:1.25;font-family:sans-serif;fill:#008000;fill-opacity:1;stroke:none;stroke-width:0.18093"
                                        x="18.74725"
                                        y="68.321449"
                                        id="flowTitle"
                                        transform="scale(1.0147109,0.98550238)"
                                        inkscape:label="#flowTitle"><tspan
                                          sodipodi:role="line"
                                          id="tspan544"
                                          style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:3.12326px;font-family:Arial;-inkscape-font-specification:'Arial, Bold';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:#008000;stroke-width:0.18093"
                                          x="18.74725"
                                          y="68.321449">PCD</tspan></text><rect
                                        style="fill:#cccccc;stroke-width:0.318252"
                                        id="rect588"
                                        width="23.675226"
                                        height="8.5903234"
                                        x="10.489982"
                                        y="11.888294" /><text
                                        xml:space="preserve"
                                        style="font-style:normal;font-weight:normal;font-size:7.76111px;line-height:1.25;font-family:sans-serif;fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.201171"
                                        x="11.591325"
                                        y="17.383556"
                                        id="flow"
                                        transform="scale(0.91261884,1.0957477)"
                                        inkscape:label="#flow"><tspan
                                          sodipodi:role="line"
                                          id="tspan642"
                                          style="font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;font-size:7.76111px;font-family:Arial;-inkscape-font-specification:'Arial, Bold';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:#008000;stroke-width:0.201171"
                                          x="11.591325"
                                          y="17.383556">000000</tspan></text></g>
                                </svg>
                            </div>
                        </div>
        </div>
        <div class="row">
                <div class="col-lg-6" id="historical_data_container"></div>
                <div class="col-lg-6" id="historical_data_container_flow"></div>
        </div>        
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
{% endblock %}

{% block javascript %}
<script type="text/javascript">
    // Inicializa el cliente MQTT
    var clients = {};
    
    
    // Conéctate al servidor MQTT y suscríbete a los temas de los sensores
    {% for sensor_url, sensorname in sensor_names %}
    clients["{{ sensorname }}"] = new Paho.MQTT.Client("192.168.100.83", Number(9001), "");
    clients["{{ sensorname }}"].onMessageArrived = function (message) {
        var newValue = parseFloat(message.payloadString);
        updateChart("{{ sensorname }}", newValue);
        updateHistoricalData("{{ sensorname }}", newValue);
    };
    clients["{{ sensorname }}"].connect({
        onSuccess: function () {
            console.log("Conexión exitosa al servidor MQTT para {{ sensorname }}");
            clients["{{ sensorname }}"].subscribe("{{ sensor_url }}");
        },
        onFailure: function (message) {
            console.log("Error en la conexión MQTT para {{ sensorname }}: " + message.errorMessage);
        }
    });
    {% endfor %}



    // Configura la suscripción y actualización para sensor_with_f
    var sensorWithFClient = new Paho.MQTT.Client("192.168.100.83", Number(9001), "");
    sensorWithFClient.onMessageArrived = function (message) {
        var newValue = parseFloat(message.payloadString);
        updateFlowText(newValue);
        updateHistoricalDataFlow("{{ sensorname }}", newValue);
    };

    sensorWithFClient.connect({
        onSuccess: function () {
            console.log("Conexión exitosa al servidor MQTT para sensor_with_f");
            // Suscríbete a los temas en sensors_with_f
            {% for sensor_url in sensors_with_f %}
            sensorWithFClient.subscribe("{{ sensor_url }}");
            {% endfor %}
        },
        onFailure: function (message) {
            console.log("Error en la conexión MQTT para sensor_with_f: " + message.errorMessage);
        }
    });


    function updateChart(sensorName, newValue) {
        var chart = Highcharts.charts.find(chart => chart.renderTo.id === sensorName + '_container');
        if (chart && !chart.renderer.forExport) {
            var point = chart.series[0].points[0];
            point.update(newValue);
        }
    }

    function updateFlowText(newValue) {
        var flowText = document.getElementById('flow');
        if (flowText) {
            flowText.textContent = newValue;
            console.log(flowText);
        }
    }

    // Configura los gráficos para cada sensor
    {% for sensor_url, sensorname in sensor_names %}
    Highcharts.chart('{{ sensorname }}_container', {
        chart: {
            type: 'gauge',
            plotBackgroundColor: null,
            plotBackgroundImage: null,
            plotBorderWidth: 0,
            plotShadow: false,
            height: '75%'
        },
        title: {
            text: '{{ sensorname }}'
        },
        pane: {
            startAngle: -90,
            endAngle: 89.9,
            background: null,
            center: ['50%', '75%'],
            size: '120%'
        },
        yAxis: {
            min: 0,
            max: 300,
            tickPixelInterval: 72,
            tickPosition: 'inside',
            tickColor: Highcharts.defaultOptions.chart.backgroundColor || '#FFFFFF',
            tickLength: 20,
            tickWidth: 2,
            minorTickInterval: null,
            labels: {
                distance: 20,
                style: {
                    fontSize: '17px'
                }
            },
            lineWidth: 0,
            plotBands: [
                {
                    from: 0,
                    to: 200,
                    color: '#55BF3B', // green
                    thickness: 20
                },
                {
                    from: 200,
                    to: 250,
                    color: '#DDDF0D', // yellow
                    thickness: 20
                },
                {
                    from: 250,
                    to: 300,
                    color: '#DF5353', // red
                    thickness: 20
                }
            ]
        },
        series: [
            {
                name: 'Pressure',
                data: [0],
                tooltip: {
                    valueSuffix: ' PSI'
                },
                dataLabels: {
                    format: '{y} PSI',
                    borderWidth: 0,
                    color: (
                        Highcharts.defaultOptions.title &&
                        Highcharts.defaultOptions.title.style &&
                        Highcharts.defaultOptions.title.style.color
                    ) || '#333333',
                    style: {
                        fontSize: '16px'
                    }
                },
                dial: {
                    radius: '100%',
                    backgroundColor: 'gray',
                    baseWidth: 12,
                    baseLength: '0%',
                    rearLength: '0%'
                },
                pivot: {
                    backgroundColor: 'gray',
                    radius: 6
                }
            }
        ]
    });
    {% endfor %}
    //Graficos para presiones
    Highcharts.chart('historical_data_container', {
        chart: {
            type: 'spline'
        },
        title: {
            text: 'Historical facts'
        },
        xAxis: {
            type: 'datetime',
            title: {
                text: 'Time'
            }
        
        },
        yAxis: {
            title: {
                text: 'Pressure (PSI)'
            }
        },
        plotOptions: {
            spline: {
                marker: {
                    enabled: true
                }
            }
        },
        series: []
    });

    // Función para actualizar la serie de tiempo con datos históricos de presiones
    function updateHistoricalData(sensorName, newValue) {
    var chart = Highcharts.charts.find(chart => chart.renderTo.id === 'historical_data_container');
    if (chart && !chart.renderer.forExport) {
        var series = chart.series.find(series => series.name === sensorName);
        var currentTime = new Date().getTime(); // Obtiene el timestamp actual
        if (!series) {
            series = chart.addSeries({
                name: sensorName,
                data: [[currentTime, newValue]] // Usa el timestamp actual
            });
        } else {
            series.addPoint([currentTime, newValue], true, series.data.length >= 20); // Limita el número de puntos en la serie
        }
        }
    }

    Highcharts.setOptions({
        global:{
            useUTC: false
        }
    });

    Highcharts.chart('historical_data_container_flow', {
            chart: {
                type: 'line'
            },
            title: {
                text: 'Historical Flow Data'
            },
            xAxis: {
                type: 'datetime',
                title: {
                    text: 'Time'
                }
            
            },
            yAxis: {
                title: {
                    text: 'Flow Count'
                }
            },
            plotOptions: {
                spline: {
                    marker: {
                        enabled: true
                    }
                }
            },
            series: []
        });
    

        function updateHistoricalDataFlow(sensorName, newValue) {
    var chart = Highcharts.charts.find(chart => chart.renderTo.id === 'historical_data_container_flow');
    if (chart && !chart.renderer.forExport) {
        var series = chart.series.find(series => series.name === sensorName);
        var currentTime = new Date().toLocaleString('en-US', { timeZone: 'America/Guayaquil' }); // Cambia 'America/New_York' a tu zona horaria
        currentTime = new Date(currentTime).getTime(); // Obtiene el timestamp local en milisegundos
        if (!series) {
            series = chart.addSeries({
                name: sensorName,
                data: [[currentTime, newValue]] // Usa el timestamp local
            });
        } else {
            series.addPoint([currentTime, newValue], true, series.data.length >= 20); // Limita el número de puntos en la serie
        }
    }
}



 //   function updateHistoricalDataFlow(sensorName, newValue) {
 //   var chart = Highcharts.charts.find(chart => chart.renderTo.id === 'historical_data_container_flow');
 //   if (chart && !chart.renderer.forExport) {
 //       var series = chart.series.find(series => series.name === sensorName);
 //       var currentTime = new Date().getTime(); // Obtiene el timestamp actual
 //       if (!series) {
 //           series = chart.addSeries({
 //               name: sensorName,
 //               data: [[currentTime, newValue]] // Usa el timestamp actual
 //           });
 //       } else {
 //           series.addPoint([currentTime, newValue], true, series.data.length >= 10); // Limita el número de puntos en la serie
 //       }
 //       }
 //   }
</script>
    
{% endblock %}